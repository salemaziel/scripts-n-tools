const botconfig = require("./botconfig.json");
const Discord = require("discord.js");
const fs = require("fs");
const bot = new Discord.Client({disableEveryone: true});
bot.commands = new Discord.Collection();

fs.readdir("./commands/", (err, files) => {

  if(err) console.log(err);
  let jsfile = files.filter(f => f.split(".").pop() === "js");
  if(jsfile.length <= 0){
    console.log("Couldn't find commands.");
    return;
  }

  jsfile.forEach((f, i) =>{
    let props = require(`./commands/${f}`);
    console.log(`${f} loaded!`);
    bot.commands.set(props.help.name, props);
  });
});

bot.on("ready", async () => {
  console.log(`${bot.user.username} is online on ${bot.guilds.size} servers!`);
  bot.user.setActivity("Everyone", {type: "WATCHING"});

});


bot.on("guildMemberRemove", function(member) {
        let cname = member.user.id
        let cChannel = member.guild.channels.find(c => c.name == cname);
        if(!cChannel) return
        member.guild.channels.find(c => c.name == cname).delete();
});



bot.on("guildMemberAdd", function(member) {

    member.addRole(member.guild.roles.find(r => r.name === "Unverified"))
    member.guild.createChannel(member.user.id, { type: `text` } ).then((createdChan) => {

        createdChan.overwritePermissions(member.guild.roles.find(r => r.name === "@everyone"), {"READ_MESSAGES": false});
            createdChan.overwritePermissions(member, {

                "READ_MESSAGES": true, "SEND_MESSAGES": true,
                "ATTACH_FILES": true, "CREATE_INSTANT_INVITE": false
            });
        let verifyEmbed = new Discord.RichEmbed()
        .setDescription("Verification")
        .setColor("#15f153")
        .addField("PreVerify", "Before sending your pic send a msg include (Age and First Name)")
        .addField("Step 1", "Grab a piece of paper")
        .addField("Step 2", "Write down your discord name and age on paper")
        .addField("Step 3", "Take a picture with your full face and the piece of paper in it")
        .addField("Step 4", "Send the picture to this chat")
        .addField("Step 5", "Wait for a staff member to verify you! Be patient!")
        .addField("Note!", "Any other msgs other than the verification picture will be ignored!")
        .addField("Important", "After 2 hours of you joining we will kick you!")
        .addField("TimeJoined", Date());

        createdChan.send("Welcome to our server! To gain full access you will be required to verify!")
        createdChan.send(verifyEmbed)
    });

});




bot.on("message", async message => {
  if(message.author.bot) return;
  if(message.channel.type === "dm") return;

  const args5 = message.content.slice(botconfig.prefix.length).trim().split(" ");
  console.log("Error not here 1");
  const cmd = args5.shift().toLowerCase();
  console.log("Error not here 2");
  const args = message.content.slice(botconfig.prefix.length).trim().split(/ +/g);
  console.log("Error not here 3");
  const command = args.shift().toLowerCase();
  console.log("Error not here 4");

  // if(message.content.indexOf(botconfig.prefix) !== 0) return;
  console.log("Error not here 5");

  try {
    let commandFile = require(`./commands/${command}.js`);
    console.log("Error not here 6");
    commandFile.run(bot, message, args);
    console.log("Error not here 7");
  } catch (err) {
    console.error(err);
  } finally {
            console.log(`${cmd} was used by: ${message.author.username}`);
        }

});

bot.login(botconfig.token);